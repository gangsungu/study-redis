## 센티널

### 고가용성 기능의 필요성
+ 레디스는 인메모리 데이터베이스
    - 모든 데이터는 메모리에서 관리하며 따로 백업 설정을 하지 않았을 때, 인스턴스가 재시작되면 모든 데이터가 유실된다
    - 복제본을 구성하면 마스터에 장애가 발생했을 경우, 데이터는 복제본 노드에 남아있으나 클라이언트가 마스터에 직접 접근하여 레디스의 엔드포인트를 복제본의 IP로 변경해야 한다
    - 운영환경이면 엔드포인트를 변경하는 동안 서비스에 장애가 발생

### 센티널이란?
+ 레디스의 고가용성 솔루션
    - 마스터-슬레이브 구조에서 페일오버(자동 장애 조치)를 제공하는 분산 시스템
+ 센티널은 독립적인 프로세스로 동작
+ 레디스 인스턴스들을 모니터링하고 장애 상황에서 자동으로 복구작업을 수행
+ 핵심 기능
    - 모니터링
        + 레디스 마스터와 슬레이브 인스턴스의 상태를 지속적으로 감시
        + 정기적으로 PING을 보내 응답 확인
        + 네트워크 분할이나 인스턴스 장애를 탐지
    - 알림
        + 레디스 인스턴스의 상태 변화시 관리자나 애플리케이션에 알림
        + 스크립트를 통해 커스텀 알림 처리도 가능하다
    - 페일오버
        + 마스터에 장애발생시 슬레이브를 마스터로 승격
        + 다른 슬레이브들을 새 마스터에 연결
        + 페일오버 과정에서 최소한의 데이터 손실 보장
    - 인스턴스 구성정보 안내
        + 클라이언트에게 현재 마스터의 정보 제공
            - 변경된 마스터의 정보를 전달하기 때문에 레디스 엔드포인트를 변경할 필요없음
+ 센티널 아키텍처 구성요소
    - 쿼럼(Quorum)
        + 센티널은 오탐을 줄이기 위해 쿼럼이라는 개념을 사용
        + 센티널은 최소 3대 이상 사용하는 것이 권장된다
            - 왜 3대 이상이어야 할까?
                + 마스터 장애 판정과 조치에는 과반수 이상의 센티널 동의가 필요
                + 센티널이 2대 : 1대 장애시 쿼럼 달성 불가
                + 센티널이 3대 : 1대 장애시에도 쿼럼 달성 가능

### 센티널 인스턴스 실행하기
+ 초기 설정 로드
    - sentinel.conf 로드
        ```bash
        # 기본 설정 항목들
        port 26379  # 센티널이 실행될 포트
        sentinel monitor mymaster 192.168.1.10 6379 2   # 모니터링할 마스터의 이름 기입
        sentinel down-after-milliseconds mymaster 5000
        sentinel parallel-syncs mymaster 1
        sentinel failover-timeout mymaster 60000
        ```
        + 입력된 마스터의 정보를 바탕으로 마스터와 연결된 모든 복제본을 찾아 추적
        + 설정파일은 센티널 인스턴스를 실행시킬 모든 서버에서 작성한 후 인스턴스를 시작해야 함
+ 페일오버 테스트
    - 센티널에서는 실제 레디스를 운영 서버에 투입하기 전 페일오버 테스트를 진행하도록 지원
    - 수동 페일오버 테스트
        + 커맨드를 사용하여 페일오버 발생
        ```bash
        # 가장 안전한 테스트 방법
        redis-cli -p 26379 SENTINEL failover mymaster

        # 페일오버 진행 상황 모니터링
        redis-cli -p 26379 SENTINEL masters
        # 상태가 "failover-in-progress"로 변경됨을 확인
        ```
        + 개발자가 예측 가능한 시점에 실행
        + 롤백 계획 수립 용이
        + 실제 장애 상황과 비슷한 프로세스에서 검증가능
    - 자동 페일오버 테스트
        + 마스터 동작을 중지시켜 페일오버 발생
        ```bash
        # 마스터 서버에서 Redis 정상 종료
        redis-cli -h master-ip -p 6379 SHUTDOWN SAVE

        # 또는 프로세스 정상 종료
        redis-cli -h master-ip -p 6379 DEBUG SLEEP 30
        ```
        + down-after-milliseconds
            - sentinel.conf에서 설정하는 값으로 센티널이 마스터에 PING을 보내 설정한 시간동안 응답이 오지 않으면 자동으로 페일오버 발생
            - 기본값 30초

### 센티널 운영하기
+ 패스워드 인증
    - 마스터와 슬레이브에 requirepass/masterauth 옵션을 사용해 패스워드를 설정한 경우, 센티널의 설정파일에도 패스워드를 지정해야 함
    - 장애상황에 센티널이 자동으로 페일오버를 진행하므로 마스터와 슬레이브는 모두 동일한 requirepass/masterauth 값을 가져야 함
    ```bash
    sentinel auth-pass <master-name> <password>
    ```

+ replica-priority
    - 복제본 우선순위(기본값 100)
    - 해당 값이 가장 작은 노드를 마스터로 선출
    - 0인 복제본은 절대 마스터로 선출되지 않는다
    - 가장 낮은 숫자가 마스터가 된다면서 왜 0은 마스터를 못해?
        + 읽기 전용 슬레이브
            - 분석/리포팅 전용 슬레이브 
            - 마스터 승격 방지
        + 백업 전용 슬레이브
            - 백업, 아카이빙 전용 슬레이브
            - 서비스용 마스터로 부적합
        + 성능이 낮은 슬레이브
            - 저사양이라 마스터 역할 수행이 불가할 때

+ 운영 중 센티널 구성 정보 변경
    - 센티널은 실행 중 모니터링할 마스터를 추가, 제거, 변경이 가능
        + 모든 센티널에 변경된 설정을 적용해야 함(다른 센티널에게 자동전파 X)
        ```bash
        sentinel monitor <master-name> <ip> <port> <quorum>
        # 새로운 마스터 모니터링 시작

        sentinel remove <master-name>
        # 마스터 모니터링 중지

        sentinel set <name> [<option> <value>]
        sentinel set mymaster dowon-after-milliseconds 1000
        # 특정 마스터에 대해 지정한 파라미터 변경 가능
        ```

+ sentinel reset <master-name>
    - 센티널 초기화
    - 센티널 인스턴스의 상태 정보를 초기화하고 모니터링 중인 마스터, 복제본, 다른 센티널 인스턴스의 정보를 새로 고친다

+ 센티널 추가
    - 마스터를 모니터링하는 센티널 인스턴스를 실행하면 자동 검색 매커니즘에 의해 자등오로 인식하여 센티널의 known-list에 추가된다
    - sentinel master <master-name> num-other-sentinels의 반환 값을 통해 센티널이 정상추가됐는지 확인이 가능