## 센티널

### 고가용성 기능의 필요성
+ 레디스는 인메모리 데이터베이스
    - 모든 데이터는 메모리에서 관리하며 따로 백업 설정을 하지 않았을 때, 인스턴스가 재시작되면 모든 데이터가 유실된다
    - 복제본을 구성하면 마스터에 장애가 발생했을 경우, 데이터는 복제본 노드에 남아있으나 클라이언트가 마스터에 직접 접근하여 레디스의 엔드포인트를 복제본의 IP로 변경해야 한다
    - 운영환경이면 엔드포인트를 변경하는 동안 서비스에 장애가 발생

### 센티널이란?
+ 레디스의 고가용성 솔루션
    - 마스터-슬레이브 구조에서 페일오버(자동 장애 조치)를 제공하는 분산 시스템
+ 센티널은 독립적인 프로세스로 동작
+ 레디스 인스턴스들을 모니터링하고 장애 상황에서 자동으로 복구작업을 수행
+ 핵심 기능
    - 모니터링
        + 레디스 마스터와 슬레이브 인스턴스의 상태를 지속적으로 감시
        + 정기적으로 PING을 보내 응답 확인
        + 네트워크 분할이나 인스턴스 장애를 탐지
    - 알림
        + 레디스 인스턴스의 상태 변화시 관리자나 애플리케이션에 알림
        + 스크립트를 통해 커스텀 알림 처리도 가능하다
    - 페일오버
        + 마스터에 장애발생시 슬레이브를 마스터로 승격
        + 다른 슬레이브들을 새 마스터에 연결
        + 페일오버 과정에서 최소한의 데이터 손실 보장
    - 인스턴스 구성정보 안내
        + 클라이언트에게 현재 마스터의 정보 제공
            - 변경된 마스터의 정보를 전달하기 때문에 레디스 엔드포인트를 변경할 필요없음
+ 센티널 아키텍처 구성요소
    - 쿼럼(Quorum)
        + 센티널은 오탐을 줄이기 위해 쿼럼이라는 개념을 사용
        + 센티널은 최소 3대 이상 사용하는 것이 권장된다
            - 왜 3대 이상이어야 할까?
                + 마스터 장애 판정과 조치에는 과반수 이상의 센티널 동의가 필요
                + 센티널이 2대 : 1대 장애시 쿼럼 달성 불가
                + 센티널이 3대 : 1대 장애시에도 쿼럼 달성 가능

### 센티널 인스턴스 실행하기
+ 초기 설정 로드
    - sentinel.conf 로드
        ```bash
        # 기본 설정 항목들
        port 26379  # 센티널이 실행될 포트
        sentinel monitor mymaster 192.168.1.10 6379 2   # 모니터링할 마스터의 이름 기입
        sentinel down-after-milliseconds mymaster 5000
        sentinel parallel-syncs mymaster 1
        sentinel failover-timeout mymaster 60000
        ```
        + 입력된 마스터의 정보를 바탕으로 마스터와 연결된 모든 복제본을 찾아 추적
        + 설정파일은 센티널 인스턴스를 실행시킬 모든 서버에서 작성한 후 인스턴스를 시작해야 함
+ 페일오버 테스트
    - 센티널에서는 실제 레디스를 운영 서버에 투입하기 전 페일오버 테스트를 진행하도록 지원
    - 수동 페일오버 테스트
        + 커맨드를 사용하여 페일오버 발생
        ```bash
        # 가장 안전한 테스트 방법
        redis-cli -p 26379 SENTINEL failover mymaster

        # 페일오버 진행 상황 모니터링
        redis-cli -p 26379 SENTINEL masters
        # 상태가 "failover-in-progress"로 변경됨을 확인
        ```
        + 개발자가 예측 가능한 시점에 실행
        + 롤백 계획 수립 용이
        + 실제 장애 상황과 비슷한 프로세스에서 검증가능
    - 자동 페일오버 테스트
        + 마스터 동작을 중지시켜 페일오버 발생
        ```bash
        # 마스터 서버에서 Redis 정상 종료
        redis-cli -h master-ip -p 6379 SHUTDOWN SAVE

        # 또는 프로세스 정상 종료
        redis-cli -h master-ip -p 6379 DEBUG SLEEP 30
        ```
        + down-after-milliseconds
            - sentinel.conf에서 설정하는 값으로 센티널이 마스터에 PING을 보내 설정한 시간동안 응답이 오지 않으면 자동으로 페일오버 발생
            - 기본값 30초

### 센티널 운영하기
+ 패스워드 인증
    - 마스터와 슬레이브에 requirepass/masterauth 옵션을 사용해 패스워드를 설정한 경우, 센티널의 설정파일에도 패스워드를 지정해야 함
    - 장애상황에 센티널이 자동으로 페일오버를 진행하므로 마스터와 슬레이브는 모두 동일한 requirepass/masterauth 값을 가져야 함
    ```bash
    sentinel auth-pass <master-name> <password>
    ```

+ replica-priority
    - 복제본 우선순위(기본값 100)
    - 해당 값이 가장 작은 노드를 마스터로 선출
    - 0인 복제본은 절대 마스터로 선출되지 않는다
    - 가장 낮은 숫자가 마스터가 된다면서 왜 0은 마스터를 못해?
        + 읽기 전용 슬레이브
            - 분석/리포팅 전용 슬레이브 
            - 마스터 승격 방지
        + 백업 전용 슬레이브
            - 백업, 아카이빙 전용 슬레이브
            - 서비스용 마스터로 부적합
        + 성능이 낮은 슬레이브
            - 저사양이라 마스터 역할 수행이 불가할 때

+ 운영 중 센티널 구성 정보 변경
    - 센티널은 실행 중 모니터링할 마스터를 추가, 제거, 변경이 가능
        + 모든 센티널에 변경된 설정을 적용해야 함(다른 센티널에게 자동전파 X)
        ```bash
        sentinel monitor <master-name> <ip> <port> <quorum>
        # 새로운 마스터 모니터링 시작

        sentinel remove <master-name>
        # 마스터 모니터링 중지

        sentinel set <name> [<option> <value>]
        sentinel set mymaster dowon-after-milliseconds 1000
        # 특정 마스터에 대해 지정한 파라미터 변경 가능
        ```

+ sentinel reset <master-name>
    - 센티널 초기화
    - 센티널 인스턴스의 상태 정보를 초기화하고 모니터링 중인 마스터, 복제본, 다른 센티널 인스턴스의 정보를 새로 고친다

+ 센티널 추가/제거
    - 마스터를 모니터링하는 센티널 인스턴스를 실행하면 자동 검색 매커니즘에 의해 자등오로 인식하여 센티널의 known-list에 추가된다
    - sentinel master <master-name> num-other-sentinels의 반환 값을 통해 센티널이 정상추가됐는지 확인이 가능
    - 센티널을 제거하기 위해서는 sentinel reset 커맨드를 사용해 센티널이 모니터링하는 정보를 리셋한다
        + 센티널끼리는 서로의 동작확인을 하지않는다

+ 센티널의 자동 페일오버 과정
    - 마스터의 장애 상황 감지
        + 센티널은 down-after-milliseconds에 지정된 값 이상동안 마스터에 보낸 PING의 응답이 오지않으면 마스터가 다운되었다고 판단
            - PING에 대한 유효한 응답은 +PONG, -LOADING, -MASTERDOWN이며 이외의 응답은 유효하지 않다고 판단한다
    - sdown, odown 상태 전환
        + 하나의 센티널 노드에서 마스터 인스턴스의 응답을 늦게 받으면 마스터의 상태를 우선 sdown으로 변경한다
        + sdown은 subjectly down, 주관적 다운을 의미
        + 이후 센티널 노드는 다른 센티널 노드들에게 장애사실을 전파
            - sentinel is-master-down-by-addr <master-ip> <master-port> <current-epoch> <*>
        + 앞선 커맨드를 받은 센티널들은 마스터의 장애 인지여부를 응답한다
        + 자기 자신을 포함해 쿼럼 값 이상의 센티널 노드에서 장애 사실을 확인하면 마스터의 상태를 odown으로 전환
            - 장애전파는 오직 마스터 노드에 대해서만 이루어진다
            - 센티널은 모든 레디스 노드를 감시하므로 복제본 노드에서 장애가 발생하는 경우, 장애를 인지하고 상태값을
            sdown으로 변경하지만 이를 다른 센티널에 전파하거나 복제본을 odown으로 변경하지 않는다
            - 페일오버를 진행할 때, sdown인 복제본은 마스터로 승격하지 않는다
    - 에포크 증가
        + 마스터에서 발생한 페일오버의 버전을 관리하는 개념
        + 센티널은 페일오버를 진행하기 전 에포크 값을 증가시킨다
        + 동일한 에포크 값으로 모든 센티널 노드가 페일오버 작업을 진행하고 있다는 것을 보장
    - 센티널 리더 선출
        + 에포크를 증가시킨 센티널은 다른 센티널 노드에게 리더를 선출하기 위해 투표하라는 메시지를 보냄
            - 이때, 증가시킨 에포크를 함께 전달하고 해당 메시지를 받은 다른 센티널 노드가 에포크를 비교한다
            - 전달받은 에포크가 클 경우, 자신의 에포크도 증가시킨 후 리더에게 투표하겠다는 응답을 보낸다
            - 만약 에포크가 같은 경우, 이미 리더인 센티널의 id를 응답한다
            - 하나의 센티널에게만 투표할 수 있으며 투표 결과는 변경이 불가하다
    - 복제본 선정 후 마스터 승격
        + 과반수 이상의 센티널이 페일오버에 동의하면 리더 센티널은 페일오버를 시도하기 위해 마스터에 적합한 복제본을 탐색한다
        + 마스터와 오랜 시간 연결이 끊겼던 복제본은 승격할 수 없다
        + 승격 우선순위
            - 슬레이브 우선순위(replica-priority) : 낮을수록 우선
            - 복제 오프셋 : 높을수록 우선(최신 데이터)
            - runID : 사전순으로 작을수록 우선
        + slaveof no one : 마스터 승격 커맨드
    - 복제 연결 성공
        + replicaof new-ip new-port
            - 기존 마스터에 연결되어 있던 복제본이 새로 승격한 마스터의 복제본이 되도록 설정하는 커맨드

+ 과반수와 쿼럼
    - sdown > odown으로 변경하기 위해서는 쿼럼 값 이상의 센티널 동의가 필요
    - 페일오버를 실행하기 위해 센티널 리더를 선출할 때는 과반수 이상의 동의가 필요
        + 쿼럼값보다 큰 센티널이 동의를 해도 그 수가 과반수보다 작으면 페일오버는 발생하지 않는다

+ 스플릿 브레인
    - 네트워크 장애때문에 여러 개의 마스터 노드가 동시에 존재하는 현상

        ```bash
        초기 상태:
        [Sentinel1] [Sentinel2] [Sentinel3]
            |           |           |
        [Master] ---- [Slave1] ---- [Slave2]

        네트워크 분할 후:
        그룹 A: [Sentinel1] [Sentinel2] - [Master]
        그룹 B: [Sentinel3] - [Slave1] [Slave2]
        ```
        + 적절한 조치가 없으면
            - 그룹 A : 기존 마스터가 계속 동작
            - 그룹 B : 센티널3이 새로운 마스터를 승격
            - 결과적으로 두개의 마스터가 존재
    - 스플릿 브레인 방지 매커니즘
        + 과반수 합의를 통해서만 페일오버를 실행한다
            ```bash
            총 Sentinel 수: 3개
            과반수: 2개 이상

            네트워크 분할 시:
            - 그룹 A (Sentinel 2개): 과반수 → 페일오버 가능
            - 그룹 B (Sentinel 1개): 과반수 미달 → 페일오버 불가
            ```
        + min-replicas-to-write
            - 마스터가 최소 개수의 슬레이브와 연결되지 않으면 쓰기 명령을 거부
            ```bash
            # 최소 1개의 슬레이브가 연결되어야 쓰기 허용
            CONFIG SET min-replicas-to-write 1

            # 슬레이브 지연시간 제한 (초)
            CONFIG SET min-replicas-max-lag 10
            ```
        + 쿼럼 설정
            ```bash
            # Sentinel 설정에서 quorum 확인
            SENTINEL masters

            # quorum이 2로 설정된 경우
            # 최소 2개의 Sentinel이 동의해야 ODOWN 판단
            ```
