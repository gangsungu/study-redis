## 레디스를 캐시로 사용하기

### 캐시란?
+ 데이터의 원본보다 더 빠르고 효율적으로 액세스할 수 있는 임시 데이터 저장
+ 애플리케이션이 다음 조건을 만족한다면 캐시를 도입했을 때, 성능을 효과적으로 개선가능
    - 원본 데이터 저장소에서 원하는 데이터를 찾기위해 검색하는 시간이 오래 걸리거나 매번 계산을 통해 데이터를 가져와야 할 때
    - 캐시에서 데이터를 가져오는 것이 원본 데이터 저장소에서 요청하는 것보다 빨라야 함
    - 캐시에 저장된 데이터는 잘 변하지 않는 데이터다
    - 캐시에 저장된 데이터는 자주 검색되는 데이터다

### 캐시로서의 레디스
+ 키-값 형태로 저장하므로 데이터를 저장하고 반환하는 것이 간단하다
+ 자체적으로 다양한 자료구조를 지원하므로 애플리케이션에서 사용하던 list, hash 등의 자료구조를 변환하는 과정없이 바로 저장가능
+ 모든 데이터를 메모리에 저장하는 인메모리 데이터 저장소이기 떄문에 읽고 쓰기가 빠르다
+ 레디스의 센티널, 클러스터 기능을 사용하면 마스터 노드의 장애를 자동으로 감지해 페일오버를 발생하기 때문에 운영자의 개입이 없어도 캐시는 정상으로 유지된다
+ 클러스터를 사용하여 캐시의 스케일 아웃을 쉽게 처리할 수 있다

### 캐싱 전략
+ 읽기 전략 look aside
    - 레디스를 캐시로 사용할 때 가장 일반적인 방법
    - 애플리케이션이 찾고자 하는 데이터가 캐시에 있는지 확인한 뒤, 데이터가 있으면 캐시에서 읽어온다(`캐시 히트`)
    - 찾고자하는 데이터가 없는 경우 캐시 미스가 발생하며 원본 데이터베이스에 접근해 데이터를 가져온 후, 캐시에 저장한다
    - 장점  
        + 레디스에 문제가 생겨 접근이 어려운 상황이 발생하더라도 원본 데이터베이스에서 데이터를 가져올 수 있다
    - 단점
        + 애플리케이션에서 레디스를 통해 데이터를 가져오는 부분이 많았다면 모든 커넥션이 원본 데이터베이스로 몰려 많은 부하를 발생시켜 애플리케이션의 성능에 영향을 미칠 수 있다
    - 찾고자하는 데이터가 레디스에 없을 때만 레디스에 데이터자 저장되기 때문에 `lazy loading`으로 부르기도 한다
    - 원본 데이터베이스에만 데이터를 저장하고 레디스에 캐싱하지 않으면 애플리케이션은 매번 레디스에 접근할 것이다
    이것을 방지하기 위해 데이터를 미리 밀어넣기도 하는데 이것을 `캐시 워밍`이라고 한다

### 쓰기 전략과 캐시의 일관성
+ 캐시는 원본 데이터베이스에 저장된 데이터를 단순히 복사해온 값
    - 따라서 원본 데이터베이스와 항상 동일한 값을 유지하는 것이 중요하다
    - 데이터가 변경될 때, 원본 데이터베이스에만 업데이트되어 캐시에는 반영되지 않는다면 데이터 간 불일치 발생(`캐시 불일치`)
    - 캐시를 이용한 쓰기 전략은 최대 3가지가 있다
        + write through
            - 데이터베이스에 업데이트할 때마다 매번 캐시에도 데이터를 업데이트하는 방법
            - 캐시는 항상 최신 데이터를 유지할 수 있으나 데이터는 매번 2회 저장되어야 한다
            - 다시 사용될만한 데이터를 캐시로 사용하는 것이 좋은데, 이 방법을 사용하면 무조건 캐시에 저장되므로 데이터 만료 시간을 사용하는 것이 권장된다
        + cache invalidation
            - 데이터베이스에 값을 업데이트할 때마다 캐시에서 데이터를 삭제하는 방법
            - 저장소에서 특정 데이터를 삭제하는 것이 새로운 데이터를 저장하는 것보다 적은 리소스를 사용하므로 write-through의 단점을 보완한 방법이라고 볼 수 있다
        + write behind(write back)
            - 쓰기가 빈번하게 발생하는 서비스에서 고려할 수 있는 방법
            - 데이터베이스에 대량의 쓰기 작업이 발생하면 많은 디스크 I/O를 유발해 성능 저하가 발생할 수 있다
            - 따라서 데이터를 빠르게 접근할 수 있는 캐시에 업데이트 후, 비동기적으로 원본 데이터베이스에 업데이트한다